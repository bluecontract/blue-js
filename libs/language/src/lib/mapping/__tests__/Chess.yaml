---
name: Chess
type:
  blueId: 6j4rVp2aAm35U7dvbYPQsdi82JUpRPb1kTfkYrhHxvqE
properties:
  playerToMove:
    description: Indicates whose move it is ('white' or 'black')
  winner:
    description:
      "Indicates who won the game (e.g., 'White', 'Black', or 'None' if\
      \ the game is not over or ended in a draw)"
    type:
      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
  draw:
    description: Indicates whether the game ended in a draw (true) or not (false)
    type:
      blueId: 4EzhSubEimSQD3zrYHRtobfPPWntUuhEz8YcdxHsi12u
  chessboard:
    description: Chessboard state in FEN notation
    type:
      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
  movesHistory:
    description: History of moves made
    type:
      blueId: 6aehfNAxHLC1PHHoDr3tYtFH3RWNbiWdFancJ1bypXEY
    itemType:
      blueId: MFGzp8CtRVLb9CF2xAc8kt3jwV99sag7jpdHemZmGz9
  gameOver:
    description:
      Indicates whether the game has ended (true) or is still in progress
      (false)
    type:
      blueId: 4EzhSubEimSQD3zrYHRtobfPPWntUuhEz8YcdxHsi12u
workflows:
  items:
    - steps:
        items:
          - type:
              blueId: DpdjTNXQdgWGxDyB1LLUNFvxSNNM9L9qGMoKZxzYMDoB
            changeset:
              items:
                - val:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1
                  op:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: replace
                  path:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: /properties/chessboard
                - val:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: white
                  op:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: replace
                  path:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: /properties/playerToMove
          - type:
              blueId: 6sdEGwtrVJhdto5CsDzm81YrJtHTZrdsenZkyCWJLniU
            event:
              type:
                blueId: H6u17c2fXJnmshciJVjqxoHVH48YirQYVbFXCTk8ZSym
              playerBlackTimeline:
                blueId: "${contract('/messaging/participants/Player Black/timeline/blueId')}"
              playerWhiteTimeline:
                blueId: "${contract('/messaging/participants/Player White/timeline/blueId')}"
      trigger:
        name: TriggerStep
        event:
          type:
            blueId: 3uzSCGkrdX4hTFGuLbyZES7NQmiuFskCpUy572GxNQuC
    - name: Move
      steps:
        items:
          - name: Check Player
            type:
              blueId: CFKAD5Up8XpNyPHwRBEwiwSUdfFUoGqVVsW29k6te88p
            code:
              type:
                blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
              value:
                "let playerToMove = contract(\"/properties/playerToMove\");\nlet\
                \ expectedTimeline = (playerToMove === 'white') ? \n    contract(\"/messaging/participants/Player\
                \ White/timeline\") :\n    contract(\"/messaging/participants/Player Black/timeline\"\
                )\nlet timeline = event.timeline;\n\nif (timeline.blueId != expectedTimeline.blueId)\
                \ {                   \n  throw new RejectAndAwaitNextEventException('Not\
                \ your move!');\n}\nreturn { }\n"
          - name: ProcessMove
            type:
              blueId: CFKAD5Up8XpNyPHwRBEwiwSUdfFUoGqVVsW29k6te88p
            code:
              type:
                blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
              value: |
                const chessModule = importBlueESModule('blue:9uGqgr62FtodKDH1KqGb1syeqHfSRo7ySQ5KY8bTutNu');
                const Chess = chessModule.Chess;

                function checkMove(from, to, position) {
                    const game = new Chess(position);

                    try {
                        const move = game.move({ from, to });
                        if (move === null) {
                            return { legal: false, position: game.fen(), gameOver: false, winner: null, draw: false };
                        }
                        const newPosition = game.fen();

                        let gameOver = game.isGameOver();
                        let winner = null;
                        let draw = false;

                        if (gameOver) {
                            if (game.isCheckmate()) {
                                winner = game.turn() === 'w' ? 'black' : 'white';
                            } else if (game.isDraw()) {
                                draw = true;
                            }
                        }

                        return { legal: true, position: newPosition, gameOver: gameOver, winner: winner, draw: draw };
                    } catch (error) {
                        return { legal: false, position: game.fen(), error: error.message, gameOver: false, winner: null, draw: false };
                    }
                }

                let position = contract("/properties/chessboard");
                let from = event.message.from;
                let to = event.message.to;
                let result;

                result = checkMove(from, to, position);

                if (!result.legal) {
                  throw new RejectAndAwaitNextEventException('Illegal move');
                }

                if (result.winner === null) {
                  result.winner = 'None';
                }

                return { result };
          - name: Emit Event
            type:
              blueId: 6sdEGwtrVJhdto5CsDzm81YrJtHTZrdsenZkyCWJLniU
            event:
              type:
                blueId: EkEtUob9ZEKzd61Fk8u1KFDZVZAhCLmzxcvTLvYgp3iw
              playerMakingMove:
                type:
                  blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                value: '${contract("/properties/playerToMove")}'
              winner:
                type:
                  blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                value: '${steps.ProcessMove.result.winner}'
              chessboardAfterMove:
                type:
                  blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                value: '${steps.ProcessMove.result.position}'
              from:
                type:
                  blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                value: '${event.message.from}'
              draw:
                type:
                  blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                value: '${steps.ProcessMove.result.draw}'
              to:
                type:
                  blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                value: '${event.message.to}'
              gameOver:
                type:
                  blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                value: '${steps.ProcessMove.result.gameOver}'
          - name: Apply Changes
            type:
              blueId: DpdjTNXQdgWGxDyB1LLUNFvxSNNM9L9qGMoKZxzYMDoB
            changeset:
              items:
                - val:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: '${steps.ProcessMove.result.position}'
                  op:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: replace
                  path:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: /properties/chessboard
                - val:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: '${steps.ProcessMove.result.draw}'
                  op:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: replace
                  path:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: /properties/draw
                - val:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: '${steps.ProcessMove.result.winner}'
                  op:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: replace
                  path:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: /properties/winner
                - val:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: '${steps.ProcessMove.result.gameOver}'
                  op:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: replace
                  path:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: /properties/gameOver
                - val:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value:
                      "${(contract(\"/properties/playerToMove\") === \"white\") ? \"\
                      black\" : \"white\"}"
                  op:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: replace
                  path:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: /properties/playerToMove
                - val:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: '${event.message}'
                  op:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: add
                  path:
                    type:
                      blueId: DLRQwz7MQeCrzjy9bohPNwtCxKEBbKaMK65KBrwjfG6K
                    value: /properties/movesHistory/-
      trigger:
        name: TriggerStep
        event:
          type:
            blueId: 5BDj3UbH6nUPh6bUQ9vfEchjV2vGLMwhd1FJ5UYaRcos
          message:
            type:
              blueId: MFGzp8CtRVLb9CF2xAc8kt3jwV99sag7jpdHemZmGz9
messaging:
  participants:
    Player White:
      description: Player White timeline
    Player Black:
      description: Player Black timeline
